- name: check latest release
  uri:
    url: https://api.github.com/repos/containerd/nerdctl/releases/latest
    return_content: true
  no_log: true
  register: json_response

- name: get release download url
  ansible.builtin.debug:
    var: item
  loop: "{{ json_response.json | community.general.json_query(release_query) }}"
  vars:
    release_query: "assets[?contains(name,'linux-amd64')&&contains(name,'full')].browser_download_url"
  register: nerdctl_release_url

- name: download release
  get_url:
    url: "{{ url }}"
    dest: "{{ ansible_env.HOME }}/{{ url | urlsplit('path') | regex_search('[^/]+$') }}"
  vars:
    url: "{{ nerdctl_release_url.results[0].item }}"
  register: archive_path

- name: extract archive
  become: true
  unarchive:
    src: "{{ archive_path.dest }}"
    dest: /usr/local
    remote_src: yes

- name: install systemd-container needed for rootless
  become: true
  apt:
    name: systemd-container
    state: latest

- name: install dbus thing
  become: true
  apt:
    name: dbus-user-session
    state: latest

- name: install rootless
  shell: containerd-rootless-setuptool.sh install
  become: true
  become_user: danielf
  become_method: machinectl

